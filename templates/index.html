<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban F칤sico - Prototipo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #0A0A0A;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        p.sub { color: #888; margin-top: 0; font-size: 0.9em; letter-spacing: 1px;}
        
        .panel-control {
            display: flex; gap: 15px; margin-bottom: 10px; z-index: 20;
            background: #1A1A1A; padding: 12px 20px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        button {
            background-color: #121212; border: 1px solid; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-reset { color: #FF5252; border-color: #FF5252; } .btn-reset:hover { background-color: #FF5252; color: #121212; }

        #escenario-wrapper { position: relative; width: 950px; height: 750px; }
        #canvas-container {
            width: 100%; height: 100%; border: 1px solid #222;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9); border-radius: 10px; background-color: transparent;
        }

        /* Displays Digitales LED */
        .display-led {
            position: absolute;
            background: #000; border: 2px solid #333; border-radius: 5px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.5em; font-weight: bold; text-align: center;
            width: 60px; padding: 2px 0; z-index: 10;
        }
        #led-U { left: 785px; top: 180px; color: #00E676; border-color: #00E676; box-shadow: 0 0 10px rgba(0,230,118,0.3);}
        #led-D { left: 450px; top: 410px; color: #2979FF; border-color: #2979FF; box-shadow: 0 0 10px rgba(41,121,255,0.3);}
        #led-C { left: 130px; top: 680px; color: #FFD700; border-color: #FFD700; box-shadow: 0 0 10px rgba(255,215,0,0.3);}
        
        /* Indicadores de Servomotor */
        .servo-status {
            position: absolute; width: 12px; height: 12px; border-radius: 50%;
            background: #333; border: 1px solid #111; z-index: 10; transition: background 0.2s;
        }
        .servo-activo { background: #FF3D00; box-shadow: 0 0 15px #FF3D00; }
        
        #servo-U { left: 755px; top: 220px; }
        #servo-D { left: 410px; top: 480px; }
    </style>
</head>
<body>
    <h1>PROTOTIPO REAL: GEMELO DIGITAL</h1>
    <p class="sub">Computaci칩n F칤sica con Sensores Laser Exactos</p>
    
    <div class="panel-control">
        <button class="btn-u" onclick="inyectarCanicas(1)">Inyectar +1 Micro-Canica</button>
        <button class="btn-d" onclick="inyectarCanicas(10)">Inyectar +10 (Lote Completo)</button>
        <button class="btn-reset" onclick="limpiarMundo()">Limpiar Maqueta</button>
    </div>

    <div id="escenario-wrapper">
        <div id="led-U" class="display-led">00</div>
        <div id="led-D" class="display-led">000</div>
        <div id="led-C" class="display-led">000</div>
        
        <div id="servo-U" class="servo-status"></div>
        <div id="servo-D" class="servo-status"></div>

        <div id="canvas-container"></div>
    </div>

    <script>
        // --- SINTETIZADOR DE AUDIO INDUSTRIAL ---
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            let ahora = audioCtx.currentTime;
            
            if (tipo === 'drop') { 
                osc.type = 'square'; osc.frequency.setValueAtTime(900, ahora); osc.frequency.exponentialRampToValueAtTime(1200, ahora + 0.03);
                gainNode.gain.setValueAtTime(0.01, ahora); gainNode.gain.exponentialRampToValueAtTime(0.001, ahora + 0.03);
                osc.start(ahora); osc.stop(ahora + 0.03);
            } else if (tipo === 'servo') { 
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ahora); osc.frequency.linearRampToValueAtTime(100, ahora + 0.5);
                gainNode.gain.setValueAtTime(0.08, ahora); gainNode.gain.linearRampToValueAtTime(0, ahora + 0.5);
                osc.start(ahora); osc.stop(ahora + 0.5);
            } else if (tipo === 'beep') { 
                osc.type = 'sine'; osc.frequency.setValueAtTime(2000, ahora); 
                gainNode.gain.setValueAtTime(0.03, ahora); gainNode.gain.exponentialRampToValueAtTime(0.001, ahora + 0.05);
                osc.start(ahora); osc.stop(ahora + 0.05);
            }
        }

        // --- MOTOR F칈SICO DE ALTA PRECISI칍N ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, 
              Composite = Matter.Composite, Events = Matter.Events;

        const engine = Engine.create();
        engine.positionIterations = 12; engine.velocityIterations = 12; // M치xima precisi칩n anti-atascos

        const render = Render.create({
            element: document.getElementById('canvas-container'), engine: engine,
            options: { width: 950, height: 750, wireframes: false, background: 'transparent' }
        });

        // --- ARQUITECTURA: CONTENEDORES DE CASCADA (SIN CUELLOS DE BOTELLA) ---
        const opPared = { isStatic: true, render: { fillStyle: '#444' } };
        let modulos = {}; 

        function crearContenedor(id, x, y, width, height, limit, colorBase) {
            // 1. Paredes Est치ticas (M치s anchas para asegurar ca칤da libre)
            const paredIzq = Bodies.rectangle(x - width/2, y, 15, height, opPared);
            const paredDer = Bodies.rectangle(x + width/2, y, 15, height, opPared);
            
            // 2. Gu칤as Exteriores (En lugar de embudos cerrados, paredes anchas que dirigen hacia adentro)
            const guiaIzq = Bodies.rectangle(x - width/2 - 25, y - height/2 - 40, 80, 15, { isStatic: true, angle: Math.PI/3, render: { fillStyle: '#555' } });
            const guiaDer = Bodies.rectangle(x + width/2 + 25, y - height/2 - 40, 80, 15, { isStatic: true, angle: -Math.PI/3, render: { fillStyle: '#555' } });

            // 3. Sensor L치ser Infrarrojo (Inmaterial, cubre todo el ancho interior)
            const sensorLaser = Bodies.rectangle(x, y - height/2 + 20, width - 15, 10, { 
                isStatic: true, isSensor: true, label: 'sensor_' + id, render: { fillStyle: 'rgba(255, 0, 0, 0.15)' } 
            });

            // 4. Escotilla Inferior (Act칰a como el servomotor)
            const escotilla = Bodies.rectangle(x, y + height/2, width - 5, 15, { render: { fillStyle: colorBase } });
            
            const bisagra = Constraint.create({
                pointA: { x: x - width/2 + 5, y: y + height/2 }, bodyB: escotilla, pointB: { x: -width/2 + 10, y: 0 },
                stiffness: 1, length: 0, render: { visible: false }
            });
            const cerrojo = Constraint.create({
                pointA: { x: x + width/2 - 5, y: y + height/2 }, bodyB: escotilla, pointB: { x: width/2 - 10, y: 0 },
                stiffness: 1, length: 0, render: { visible: false }
            });

            Composite.add(engine.world, [paredIzq, paredDer, guiaIzq, guiaDer, sensorLaser, escotilla, bisagra, cerrojo]);
            modulos[id] = { id, escotilla, cerrojo, limite: limit, conteoActual: 0, abierta: false };
        }

        // --- INSTANCIAR LOS M칍DULOS ---
        // U: Unidades. L칤mite exacto 10.
        crearContenedor('U', 820, 150, 90, 120, 10, '#00E676'); // Ancho aumentado a 90 para evitar atascos
        
        // D: Decenas. L칤mite exacto 100.
        crearContenedor('D', 480, 380, 120, 200, 100, '#2979FF'); // Ancho a 120
        
        // C: Centenas. Dep칩sito final. (Movido m치s abajo para la cascada perfecta)
        crearContenedor('C', 160, 650, 160, 250, 9999, '#FFD700');

        // --- RAMPAS MET츼LICAS GEOM칄TRICAS PERFECTAS ---
        // Rampa de U a D (Inclinada hacia la IZQUIERDA: 치ngulo negativo)
        // Centro X: (820+480)/2 = 650. Centro Y: aprox 240.
        Composite.add(engine.world, Bodies.rectangle(650, 240, 380, 15, { isStatic: true, angle: -0.28, render: { fillStyle: '#666' } }));
        
        // Rampa de D a C (Inclinada hacia la IZQUIERDA: 치ngulo negativo)
        // Centro X: (480+160)/2 = 320. Centro Y: aprox 500.
        Composite.add(engine.world, Bodies.rectangle(320, 500, 360, 15, { isStatic: true, angle: -0.28, render: { fillStyle: '#666' } }));

        // --- L칍GICA DE INYECCI칍N L칈QUIDA ---
        let canicas = [];
        function inyectarCanicas(cantidad) {
            let inyectadas = 0;
            // Intervalo m치s largo (100ms) para que caigan una por una sin chocar en el aire
            let intervalo = setInterval(() => {
                reproducirSonido('drop');
                // Offset aleatorio suave y altura mayor para ganar velocidad terminal
                let nuevaCanica = Bodies.circle(820 + (Math.random() * 30 - 15), -40, 6, { 
                    restitution: 0.1, mass: 1, friction: 0.001, frictionAir: 0.002, render: { fillStyle: '#00E676' }
                });
                nuevaCanica.sensoresPasados = new Set();
                canicas.push(nuevaCanica);
                Composite.add(engine.world, nuevaCanica);
                
                inyectadas++;
                if (inyectadas >= cantidad) clearInterval(intervalo);
            }, 100); 
        }

        function limpiarMundo() {
            canicas.forEach(c => Composite.remove(engine.world, c));
            canicas = [];
            ['U', 'D', 'C'].forEach(id => { modulos[id].conteoActual = 0; });
            actualizarDisplays();
        }

        function actualizarDisplays() {
            document.getElementById('led-U').innerText = modulos['U'].conteoActual.toString().padStart(2, '0');
            document.getElementById('led-D').innerText = modulos['D'].conteoActual.toString().padStart(3, '0');
            document.getElementById('led-C').innerText = modulos['C'].conteoActual.toString().padStart(3, '0');
        }

        // --- CEREBRO DIGITAL DEL SERVOMOTOR ---
        function accionarServo(id) {
            let mod = modulos[id];
            if (mod.abierta) return;
            mod.abierta = true;
            
            reproducirSonido('servo');
            let luzStatus = document.getElementById('servo-' + id);
            if(luzStatus) luzStatus.classList.add('servo-activo');

            // Abrir la compuerta
            Composite.remove(engine.world, mod.cerrojo);

            // Darle tiempo para que caiga todo el lote de canicas
            setTimeout(() => {
                // Forzar cierre cinem치tico
                Body.setAngle(mod.escotilla, 0);
                Body.setAngularVelocity(mod.escotilla, 0);
                Composite.add(engine.world, mod.cerrojo);
                
                if(luzStatus) luzStatus.classList.remove('servo-activo');
                mod.conteoActual = 0; // Resetear el LED *despu칠s* de que se vac칤a
                mod.abierta = false;
                actualizarDisplays();
            }, 2500); // 2.5 segundos exactos
        }

        // --- SISTEMA DE SENSORES L츼SER ---
        Events.on(engine, 'collisionStart', function(event) {
            event.pairs.forEach(pair => {
                let bodyA = pair.bodyA; let bodyB = pair.bodyB;
                let sensor = null; let canica = null;

                if (bodyA.label && bodyA.label.startsWith('sensor_')) { sensor = bodyA; canica = bodyB; }
                else if (bodyB.label && bodyB.label.startsWith('sensor_')) { sensor = bodyB; canica = bodyA; }

                if (sensor && canica && canica.sensoresPasados) {
                    let moduloId = sensor.label.split('_')[1]; 
                    
                    if (!canica.sensoresPasados.has(moduloId)) {
                        canica.sensoresPasados.add(moduloId); 
                        reproducirSonido('beep');
                        
                        let mod = modulos[moduloId];
                        mod.conteoActual++;
                        actualizarDisplays();

                        // Pintar la canica seg칰n la magnitud en la que acaba de entrar
                        if (moduloId === 'D') canica.render.fillStyle = '#2979FF';
                        if (moduloId === 'C') canica.render.fillStyle = '#FFD700';

                        // 游꿢 CONDICI칍N EXACTA DE APERTURA: Si llega a 10 (o 100)
                        if (mod.conteoActual === mod.limite && !mod.abierta) {
                            accionarServo(moduloId);
                        }
                    }
                }
            });
        });

        Render.run(render);
        const runner = Runner.create(); Runner.run(runner, engine);
    </script>
</body>
</html>
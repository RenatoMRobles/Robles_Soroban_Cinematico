<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban Cinem√°tico - Robles y Robles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #121212;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        
        #marcador {
            font-size: 3.5em; font-weight: bold; color: #FFD700; 
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace; letter-spacing: 5px;
        }

        .panel-control {
            display: flex; gap: 20px; margin-bottom: 20px; z-index: 20;
            background: #1A1A1A; padding: 15px 25px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .columna-btns { display: flex; flex-direction: column; gap: 8px; align-items: center;}
        .titulo-col { font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;}
        .fila-btns { display: flex; gap: 8px; }
        
        button {
            background-color: #121212; border: 1px solid; padding: 8px 14px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-c { color: #FFD700; border-color: #FFD700; } .btn-c:hover { background-color: #FFD700; color: #121212; }
        .btn-sub { color: #FF5252; border-color: #FF5252; opacity: 0.8;} .btn-sub:hover { background-color: #FF5252; color: #121212; opacity: 1;}
        .btn-reset { color: #BDBDBD; border-color: #BDBDBD; height: 100%; align-self: center; padding: 10px 25px;} .btn-reset:hover { background-color: #BDBDBD; color: #121212; }

        #escenario { position: relative; width: 800px; height: 450px; }
        #canvas-container {
            width: 100%; height: 100%; border: 1px solid #333;
            box-shadow: 0 0 25px rgba(0, 230, 118, 0.15); border-radius: 10px; background-color: transparent;
        }

        .iman-visual {
            position: absolute; top: -10px; width: 80px; height: 35px;
            background: #222; border: 2px solid #444; border-radius: 8px 8px 20px 20px;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.8); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px;
        }
        
        .iman-visual::after {
            content: ''; width: 60px; height: 10px;
            background: repeating-linear-gradient(90deg, #FF5252, #FF5252 10px, #2979FF 10px, #2979FF 20px);
            border-radius: 5px; opacity: 0.2; transition: opacity 0.3s ease;
        }

        .iman-visual.activo {
            top: 20px; box-shadow: 0 25px 50px rgba(0, 230, 118, 0.6), inset 0 -5px 10px rgba(0,0,0,0.8);
            border-color: #00E676;
        }
        .iman-visual.activo::after { opacity: 1; box-shadow: 0 0 15px #00E676; }

        #iman-C { left: 110px; } #iman-D { left: 360px; } #iman-U { left: 610px; }

    </style>
</head>
<body>
    <h1>SOROBAN CINEM√ÅTICO</h1>
    <div id="marcador">000</div> 
    
    <div class="panel-control">
        <div class="columna-btns">
            <span class="titulo-col">Centenas</span>
            <div class="fila-btns"><button class="btn-c" onclick="operar('C', 1)">+100</button><button class="btn-c" onclick="operar('C', 5)">+500</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('C', -1)">-100</button><button class="btn-sub" onclick="operar('C', -5)">-500</button></div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Decenas</span>
            <div class="fila-btns"><button class="btn-d" onclick="operar('D', 1)">+10</button><button class="btn-d" onclick="operar('D', 5)">+50</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('D', -1)">-10</button><button class="btn-sub" onclick="operar('D', -5)">-50</button></div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Unidades</span>
            <div class="fila-btns"><button class="btn-u" onclick="operar('U', 1)">+1</button><button class="btn-u" onclick="operar('U', 5)">+5</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('U', -1)">-1</button><button class="btn-sub" onclick="operar('U', -5)">-5</button></div>
        </div>
        <button class="btn-reset" onclick="limpiarSoroban()">RESET</button>
    </div>

    <div id="escenario">
        <div id="iman-C" class="iman-visual"></div>
        <div id="iman-D" class="iman-visual"></div>
        <div id="iman-U" class="iman-visual"></div>
        <div id="canvas-container"></div>
    </div>

    <script>
        // üéµ AUDIO CORPORATIVO
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            let ahora = audioCtx.currentTime;

            if (tipo === 'add') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, ahora); osc.frequency.exponentialRampToValueAtTime(1200, ahora + 0.1);
                gainNode.gain.setValueAtTime(0.1, ahora); gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.1);
                osc.start(ahora); osc.stop(ahora + 0.1);
            } else if (tipo === 'sub') {
                osc.type = 'square'; osc.frequency.setValueAtTime(200, ahora); osc.frequency.exponentialRampToValueAtTime(800, ahora + 0.3);
                gainNode.gain.setValueAtTime(0.05, ahora); gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.3);
                osc.start(ahora); osc.stop(ahora + 0.3);
            } else if (tipo === 'magia') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, ahora); osc.frequency.setValueAtTime(1200, ahora + 0.1); osc.frequency.setValueAtTime(1600, ahora + 0.2);
                gainNode.gain.setValueAtTime(0.1, ahora); gainNode.gain.linearRampToValueAtTime(0, ahora + 0.3);
                osc.start(ahora); osc.stop(ahora + 0.3);
            }
        }

        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('canvas-container'), engine: engine,
            options: { width: 800, height: 450, wireframes: false, background: 'transparent' }
        });

        const opPared = { render: { fillStyle: '#333' } };

        // üõ†Ô∏è FIX GEOM√âTRICO: Contenedores estables, sin rascacielos
        function crearColumna(x) {
            const base = Bodies.rectangle(x, 340, 140, 30, opPared); 
            const izq = Bodies.rectangle(x - 60, 240, 20, 230, opPared); 
            const der = Bodies.rectangle(x + 60, 240, 20, 230, opPared);
            const contenedor = Body.create({ parts: [base, izq, der], friction: 0.8, mass: 10, inertia: Infinity });
            
            const ancla = Bodies.circle(x, 20, 10, { isStatic: true, render: { visible: false } });
            // El resorte se ancla equilibradamente respecto al nuevo centro de masa real
            const resorte = Constraint.create({
                bodyA: ancla, bodyB: contenedor, pointB: { x: 0, y: -90 }, 
                stiffness: 0.007, damping: 0.1, length: 150      
            });
            Composite.add(engine.world, [contenedor, ancla, resorte]);
        }

        crearColumna(150); crearColumna(400); crearColumna(650); 

        // üß† MEMORIA L√ìGICA DIFERENCIAL
        let valorTotal = 0;
        let estadoFisico = { C: {v5: 0, v1: 0}, D: {v5: 0, v1: 0}, U: {v5: 0, v1: 0} };
        let canicasCuerpos = []; 

        function actualizarMarcador() {
            document.getElementById('marcador').innerText = valorTotal.toString().padStart(3, '0');
        }

        function animarImanVisual(columna) {
            let ids = columna === 'ALL' ? ['iman-C', 'iman-D', 'iman-U'] : ['iman-' + columna];
            ids.forEach(id => {
                let el = document.getElementById(id);
                if(el) { el.classList.add('activo'); setTimeout(() => el.classList.remove('activo'), 500); }
            });
        }

        function limpiarSoroban() {
            if (valorTotal === 0) return;
            reproducirSonido('sub'); animarImanVisual('ALL');
            
            canicasCuerpos.forEach(c => {
                Matter.Body.applyForce(c, c.position, { x: 0, y: -0.09 * c.mass });
                setTimeout(() => Composite.remove(engine.world, c), 500);
            });
            canicasCuerpos = [];
            estadoFisico = { C: {v5:0, v1:0}, D: {v5:0, v1:0}, U: {v5:0, v1:0} };
            valorTotal = 0; actualizarMarcador();
        }

        function crearCanicaFisica(columna, valorMag, offsetY = 0) {
            let x = columna === 'U' ? 650 : (columna === 'D' ? 400 : 150);
            x = x + (Math.random() * 8 - 4); // Offset sutil
            
            let radio = valorMag === 1 ? 15 : 30;
            let masa = valorMag === 1 ? 2 : 10;
            let color = '#FFF';

            if (columna === 'U') color = valorMag === 1 ? '#00E676' : '#FF4081'; 
            if (columna === 'D') color = valorMag === 1 ? '#2979FF' : '#B388FF'; 
            if (columna === 'C') color = valorMag === 1 ? '#FFD700' : '#FF6D00'; 

            // Nacen seguro, sin riesgo de atravesar suelos
            let nuevaCanica = Bodies.circle(x, -20 - offsetY, radio, { 
                restitution: 0.3, mass: masa, frictionAir: 0.015, render: { fillStyle: color } 
            });
            // üè∑Ô∏è Etiqueta cu√°ntica para rastreo (ej: "U1", "D5")
            nuevaCanica.customType = columna + valorMag;
            
            canicasCuerpos.push(nuevaCanica); 
            Composite.add(engine.world, nuevaCanica);
        }

        // üß† MOTOR DIFERENCIAL (Aplica solo las diferencias matem√°ticas)
        function procesarDelta(columna, valorFicha, diferencia) {
            if (diferencia === 0) return; // No tocamos lo que no cambia
            
            let typeStr = columna + valorFicha; 

            if (diferencia > 0) {
                // Agregar las canicas que faltan
                let dropOffset = 0;
                for(let i=0; i < diferencia; i++) {
                    crearCanicaFisica(columna, valorFicha, dropOffset);
                    dropOffset += 45; // Separaci√≥n segura para evitar superposiciones
                }
            } else if (diferencia < 0) {
                // Remover estrictamente la cantidad de canicas solicitada
                let cantidadARemover = Math.abs(diferencia);
                let removidas = 0;
                animarImanVisual(columna);

                // Iteramos al rev√©s para eliminar de la matriz de forma segura
                for (let i = canicasCuerpos.length - 1; i >= 0; i--) {
                    let c = canicasCuerpos[i];
                    if (c.customType === typeStr) {
                        // Fuerza magn√©tica pura e individualizada
                        Matter.Body.applyForce(c, c.position, { x: 0, y: -0.09 * c.mass });
                        
                        canicasCuerpos.splice(i, 1);
                        setTimeout(() => Composite.remove(engine.world, c), 500);

                        removidas++;
                        if (removidas === cantidadARemover) break;
                    }
                }
            }
        }

        // üßÆ OPERACI√ìN MAESTRA
        function operar(columna, valorPresionado) {
            let mult = columna === 'C' ? 100 : (columna === 'D' ? 10 : 1);
            let totalProyectado = valorTotal + (valorPresionado * mult);

            if (totalProyectado < 0) return; // Soroban no admite negativos
            if (totalProyectado > 999) totalProyectado = 999;

            reproducirSonido(valorPresionado > 0 ? 'add' : 'sub');
            
            // Detectar salto de magnitud (la magia del desborde)
            let saltoC = Math.floor(totalProyectado/100) > Math.floor(valorTotal/100);
            let saltoD = Math.floor((totalProyectado%100)/10) > Math.floor((valorTotal%100)/10);
            if (saltoC || saltoD) setTimeout(() => reproducirSonido('magia'), 200);

            valorTotal = totalProyectado;
            actualizarMarcador();

            // Desglose del nuevo estado matem√°tico
            let nC = Math.floor(valorTotal / 100);
            let nD = Math.floor((valorTotal % 100) / 10);
            let nU = valorTotal % 10;

            let nuevoEstadoFisico = {
                C: { v5: Math.floor(nC / 5), v1: nC % 5 },
                D: { v5: Math.floor(nD / 5), v1: nD % 5 },
                U: { v5: Math.floor(nU / 5), v1: nU % 5 }
            };

            // Inyectamos las diferencias (El milagro cinem√°tico)
            procesarDelta('C', 5, nuevoEstadoFisico.C.v5 - estadoFisico.C.v5);
            procesarDelta('C', 1, nuevoEstadoFisico.C.v1 - estadoFisico.C.v1);
            procesarDelta('D', 5, nuevoEstadoFisico.D.v5 - estadoFisico.D.v5);
            procesarDelta('D', 1, nuevoEstadoFisico.D.v1 - estadoFisico.D.v1);
            procesarDelta('U', 5, nuevoEstadoFisico.U.v5 - estadoFisico.U.v5);
            procesarDelta('U', 1, nuevoEstadoFisico.U.v1 - estadoFisico.U.v1);

            // Guardamos el nuevo estado como referencia para el futuro
            estadoFisico = nuevoEstadoFisico;
        }

        Render.run(render);
        const runner = Runner.create(); Runner.run(runner, engine);
    </script>
</body>
</html>
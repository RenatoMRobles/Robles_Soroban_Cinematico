<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban Cinemático - Robles y Robles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #121212;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        
        #marcador {
            font-size: 3.5em; font-weight: bold; color: #FFD700; 
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace; letter-spacing: 5px;
        }

        #canvas-container {
            width: 800px; height: 450px; border: 1px solid #333;
            box-shadow: 0 0 25px rgba(0, 230, 118, 0.15); border-radius: 10px;
        }
        
        /* Tablero de Mando Expandido */
        .panel-control {
            display: flex; gap: 20px; margin-bottom: 10px;
            background: #1A1A1A; padding: 15px 25px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .columna-btns { display: flex; flex-direction: column; gap: 8px; align-items: center;}
        .titulo-col { font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;}
        .fila-btns { display: flex; gap: 8px; }
        
        button {
            background-color: #121212; border: 1px solid; padding: 8px 14px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        
        /* Botones de SUMA */
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-c { color: #FFD700; border-color: #FFD700; } .btn-c:hover { background-color: #FFD700; color: #121212; }

        /* Botones de RESTA (Dark Red) */
        .btn-sub { color: #FF5252; border-color: #FF5252; opacity: 0.8;}
        .btn-sub:hover { background-color: #FF5252; color: #121212; opacity: 1;}

        .btn-reset { color: #BDBDBD; border-color: #BDBDBD; height: 100%; align-self: center; padding: 10px 25px;}
        .btn-reset:hover { background-color: #BDBDBD; color: #121212; }
    </style>
</head>
<body>
    <h1>SOROBAN CINEMÁTICO</h1>
    <div id="marcador">000</div> 
    
    <div class="panel-control">
        <div class="columna-btns">
            <span class="titulo-col">Centenas</span>
            <div class="fila-btns">
                <button class="btn-c" onclick="operar('C', 1)">+100</button>
                <button class="btn-c" onclick="operar('C', 5)">+500</button>
            </div>
            <div class="fila-btns">
                <button class="btn-sub" onclick="operar('C', -1)">-100</button>
                <button class="btn-sub" onclick="operar('C', -5)">-500</button>
            </div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Decenas</span>
            <div class="fila-btns">
                <button class="btn-d" onclick="operar('D', 1)">+10</button>
                <button class="btn-d" onclick="operar('D', 5)">+50</button>
            </div>
            <div class="fila-btns">
                <button class="btn-sub" onclick="operar('D', -1)">-10</button>
                <button class="btn-sub" onclick="operar('D', -5)">-50</button>
            </div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Unidades</span>
            <div class="fila-btns">
                <button class="btn-u" onclick="operar('U', 1)">+1</button>
                <button class="btn-u" onclick="operar('U', 5)">+5</button>
            </div>
            <div class="fila-btns">
                <button class="btn-sub" onclick="operar('U', -1)">-1</button>
                <button class="btn-sub" onclick="operar('U', -5)">-5</button>
            </div>
        </div>
        <button class="btn-reset" onclick="limpiarSoroban()">RESET</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        // --- SINTETIZADOR DE AUDIO CORPORATIVO ---
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);

            let ahora = audioCtx.currentTime;
            if (tipo === 'add') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, ahora);
                osc.frequency.exponentialRampToValueAtTime(1200, ahora + 0.1);
                gainNode.gain.setValueAtTime(0.1, ahora);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.1);
                osc.start(ahora); osc.stop(ahora + 0.1);
            } else if (tipo === 'sub') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, ahora);
                osc.frequency.exponentialRampToValueAtTime(150, ahora + 0.15);
                gainNode.gain.setValueAtTime(0.1, ahora);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.15);
                osc.start(ahora); osc.stop(ahora + 0.15);
            } else if (tipo === 'magia') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, ahora);
                osc.frequency.setValueAtTime(1200, ahora + 0.1);
                osc.frequency.setValueAtTime(1600, ahora + 0.2);
                gainNode.gain.setValueAtTime(0.1, ahora);
                gainNode.gain.linearRampToValueAtTime(0, ahora + 0.3);
                osc.start(ahora); osc.stop(ahora + 0.3);
            }
        }

        // --- MOTOR FÍSICO Y LÓGICA DE MATRICES ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, 
              Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: 800, height: 450, wireframes: false, background: 'transparent' }
        });

        const opPared = { render: { fillStyle: '#333' } };

        function crearColumna(x) {
            const base = Bodies.rectangle(x, 300, 140, 20, opPared);
            const izq = Bodies.rectangle(x - 60, 210, 20, 200, opPared);
            const der = Bodies.rectangle(x + 60, 210, 20, 200, opPared);
            const contenedor = Body.create({ parts: [base, izq, der], friction: 0.5, mass: 10, inertia: Infinity });
            const ancla = Bodies.circle(x, -10, 10, { isStatic: true, render: { visible: false } });
            const resorte = Constraint.create({
                bodyA: ancla, bodyB: contenedor, pointB: { x: 0, y: -80 }, 
                stiffness: 0.007, damping: 0.1, length: 150      
            });
            Composite.add(engine.world, [contenedor, ancla, resorte]);
        }

        crearColumna(150); crearColumna(400); crearColumna(650); 

        // Variables de Lógica
        let valU = 0, valD = 0, valC = 0;
        let canicasCuerpos = []; 

        function actualizarMarcador() {
            let total = (valC * 100) + (valD * 10) + valU;
            document.getElementById('marcador').innerText = total.toString().padStart(3, '0');
        }

        function limpiarSoroban() {
            reproducirSonido('sub');
            canicasCuerpos.forEach(c => Composite.remove(engine.world, c));
            canicasCuerpos = [];
            valU = 0; valD = 0; valC = 0;
            actualizarMarcador();
        }

        function crearCanicaFisica(columna, valorMag) {
            let x = columna === 'U' ? 650 : (columna === 'D' ? 400 : 150);
            let radio = valorMag === 1 ? 15 : 30;
            let masa = valorMag === 1 ? 2 : 10;
            let color = '#FFF';

            if (columna === 'U') color = valorMag === 1 ? '#00E676' : '#FF4081'; 
            if (columna === 'D') color = valorMag === 1 ? '#2979FF' : '#B388FF'; 
            if (columna === 'C') color = valorMag === 1 ? '#FFD700' : '#FF6D00'; 

            let nuevaCanica = Bodies.circle(x, 50, radio, { restitution: 0.5, mass: masa, render: { fillStyle: color } });
            canicasCuerpos.push(nuevaCanica);
            Composite.add(engine.world, nuevaCanica);
        }

        // LÓGICA MAESTRA DE SUSTRACCIÓN Y PRESTAMOS
        function operar(columna, valor) {
            reproducirSonido(valor > 0 ? 'add' : 'sub');

            if (columna === 'U') valU += valor;
            if (columna === 'D') valD += valor;
            if (columna === 'C') valC += valor;

            // Calcular el total cuántico para proteger de negativos absolutos
            let totalCalculado = (valC * 100) + (valD * 10) + valU;
            if (totalCalculado < 0) {
                valC = 0; valD = 0; valU = 0;
            }

            if (valor > 0) {
                // Si es suma, dejamos que la gravedad haga lo suyo antes de agrupar
                crearCanicaFisica(columna, Math.abs(valor));
                actualizarMarcador();
                setTimeout(() => sincronizarEstadoFisico(false), 400); 
            } else {
                // Si es resta, forzamos la reconstrucción inmediata para simular el prestamo
                sincronizarEstadoFisico(true); 
            }
        }

        function sincronizarEstadoFisico(forzarReconstruccion) {
            let total = (valC * 100) + (valD * 10) + valU;
            if (total > 999) total = 999;
            if (total < 0) total = 0;

            // Desempaquetado inteligente
            let nC = Math.floor(total / 100);
            let nD = Math.floor((total % 100) / 10);
            let nU = total % 10;

            // Si hay un cambio estructural (desborde) o fue una resta (forzado)
            if (nC !== valC || nD !== valD || nU !== valU || forzarReconstruccion) {
                
                // Si ganamos una magnitud por agrupar unidades, suena la magia
                if(nC > valC || nD > valD) reproducirSonido('magia');

                valC = nC; valD = nD; valU = nU;

                // Destruir universo físico actual
                canicasCuerpos.forEach(c => Composite.remove(engine.world, c));
                canicasCuerpos = [];

                // Recrear universo matemáticamente perfecto
                let c5 = Math.floor(valC / 5); let c1 = valC % 5;
                for(let i=0; i<c5; i++) crearCanicaFisica('C', 5);
                for(let i=0; i<c1; i++) crearCanicaFisica('C', 1);

                let d5 = Math.floor(valD / 5); let d1 = valD % 5;
                for(let i=0; i<d5; i++) crearCanicaFisica('D', 5);
                for(let i=0; i<d1; i++) crearCanicaFisica('D', 1);

                let u5 = Math.floor(valU / 5); let u1 = valU % 5;
                for(let i=0; i<u5; i++) crearCanicaFisica('U', 5);
                for(let i=0; i<u1; i++) crearCanicaFisica('U', 1);
            }
            actualizarMarcador();
        }

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
    </script>
</body>
</html>
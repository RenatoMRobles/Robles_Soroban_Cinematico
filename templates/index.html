<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban F√≠sico - Prototipo Real</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #0A0A0A;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 10px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        p.sub { color: #888; margin-top: 0; font-size: 0.9em; letter-spacing: 1px; margin-bottom: 10px;}
        
        .panel-control {
            display: flex; gap: 15px; margin-bottom: 10px; z-index: 20;
            background: #1A1A1A; padding: 12px 20px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        button {
            background-color: #121212; border: 1px solid; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-t { color: #FF4081; border-color: #FF4081; } .btn-t:hover { background-color: #FF4081; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-reset { color: #FF5252; border-color: #FF5252; } .btn-reset:hover { background-color: #FF5252; color: #121212; }

        #escenario-wrapper { position: relative; width: 950px; height: 950px; }
        #canvas-container {
            width: 100%; height: 100%; border: 1px solid #222;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9); border-radius: 10px; background-color: transparent;
        }

        /* Displays Digitales LED */
        .display-led {
            position: absolute; background: #000; border: 2px solid #333; border-radius: 5px;
            font-family: 'Courier New', Courier, monospace; font-size: 1.5em; font-weight: bold; 
            text-align: center; width: 60px; padding: 2px 0; z-index: 10;
        }
        #led-U { left: 790px; top: 70px; color: #00E676; border-color: #00E676; box-shadow: 0 0 10px rgba(0,230,118,0.3);}
        #led-D { left: 470px; top: 450px; color: #2979FF; border-color: #2979FF; box-shadow: 0 0 10px rgba(41,121,255,0.3);}
        #led-C { left: 150px; top: 850px; color: #FFD700; border-color: #FFD700; box-shadow: 0 0 10px rgba(255,215,0,0.3);}
        
        /* Indicadores de Servomotor */
        .servo-status {
            position: absolute; width: 14px; height: 14px; border-radius: 50%;
            background: #333; border: 1px solid #111; z-index: 10; transition: background 0.2s;
        }
        .servo-activo { background: #00E676; box-shadow: 0 0 20px #00E676; } 
        
        #servo-U { left: 885px; top: 100px; } 
        #servo-D { left: 575px; top: 500px; }
    </style>
</head>
<body>
    <h1>PROTOTIPO REAL: GEMELO DIGITAL</h1>
    <p class="sub">Entradas Asim√©tricas, Topes de Seguridad y Arpegio ASMR</p>
    
    <div class="panel-control">
        <button class="btn-u" onclick="inyectarCanica(1)">+1 (Micro)</button>
        <button class="btn-t" onclick="inyectarCanica(5)">+5 (Tombolocha)</button>
        <button class="btn-d" onclick="inyectarLote(10)">+10 (Lote Micro)</button>
        <button class="btn-reset" onclick="limpiarMundo()">Limpiar Maqueta</button>
    </div>

    <div id="escenario-wrapper">
        <div id="led-U" class="display-led">00</div>
        <div id="led-D" class="display-led">000</div>
        <div id="led-C" class="display-led">000</div>
        
        <div id="servo-U" class="servo-status"></div>
        <div id="servo-D" class="servo-status"></div>

        <div id="canvas-container"></div>
    </div>

    <script>
        // --- üé∂ SINTETIZADOR DE AUDIO ASMR (Ondas Senoidales Relajantes) ---
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            let ahora = audioCtx.currentTime;
            
            if (tipo === 'drop') { 
                // Gota de cristal
                osc.type = 'sine'; osc.frequency.setValueAtTime(1800, ahora); 
                gainNode.gain.setValueAtTime(0.04, ahora); gainNode.gain.exponentialRampToValueAtTime(0.001, ahora + 0.15);
                osc.start(ahora); osc.stop(ahora + 0.15);
            } else if (tipo === 'drop5') { 
                // Marimba profunda de cristal
                osc.type = 'sine'; osc.frequency.setValueAtTime(700, ahora);
                gainNode.gain.setValueAtTime(0.08, ahora); gainNode.gain.exponentialRampToValueAtTime(0.001, ahora + 0.25);
                osc.start(ahora); osc.stop(ahora + 0.25);
            } else if (tipo === 'victoria') { 
                // üé∂ ARPEGIO ASMR DE VICTORIA (Do Mayor 7)
                let frecuencias = [523.25, 659.25, 783.99, 987.77, 1046.50]; // Do, Mi, Sol, Si, Do
                frecuencias.forEach((freq, index) => {
                    let oscV = audioCtx.createOscillator(); let gnV = audioCtx.createGain();
                    oscV.connect(gnV); gnV.connect(audioCtx.destination);
                    oscV.type = 'sine'; oscV.frequency.value = freq;
                    
                    let tiempo = ahora + (index * 0.12); // Cascada lenta y relajante
                    gnV.gain.setValueAtTime(0, tiempo);
                    gnV.gain.linearRampToValueAtTime(0.08, tiempo + 0.05); // Suave ataque
                    gnV.gain.exponentialRampToValueAtTime(0.001, tiempo + 1.5); // Resonancia larga
                    
                    oscV.start(tiempo); oscV.stop(tiempo + 1.5);
                });
            } else if (tipo === 'beep') { 
                // Campanilla del l√°ser suave
                osc.type = 'sine'; osc.frequency.setValueAtTime(2400, ahora); 
                gainNode.gain.setValueAtTime(0.02, ahora); gainNode.gain.exponentialRampToValueAtTime(0.001, ahora + 0.05);
                osc.start(ahora); osc.stop(ahora + 0.05);
            }
        }

        // --- MOTOR F√çSICO ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, 
              Composite = Matter.Composite, Events = Matter.Events;

        const engine = Engine.create();
        engine.positionIterations = 15; engine.velocityIterations = 15; 

        const render = Render.create({
            element: document.getElementById('canvas-container'), engine: engine,
            options: { width: 950, height: 950, wireframes: false, background: 'transparent' }
        });

        // --- üìê FUNCIONES GEOM√âTRICAS OPTIMIZADAS ---
        const opPared = { isStatic: true, render: { fillStyle: '#444' } };
        let modulos = {}; 

        // Rampa con TOPE DE SEGURIDAD
        function crearRampa(x1, y1, x2, y2) {
            let cx = (x1 + x2) / 2; let cy = (y1 + y2) / 2;
            let longitud = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            let angulo = Math.atan2(y2 - y1, x2 - x1);
            let rampa = Bodies.rectangle(cx, cy, longitud, 8, { isStatic: true, angle: angulo, render: { fillStyle: '#666' } });
            
            // üõ°Ô∏è Tope de seguridad en el inicio para evitar que caigan a la derecha
            let tope = Bodies.rectangle(x1 + 5, y1 - 35, 8, 80, { isStatic: true, render: { fillStyle: '#555' } });
            
            Composite.add(engine.world, [rampa, tope]);
        }

        function crearContenedor(id, x, y, width, height, limit, colorBase) {
            // Pared Izquierda (Normal)
            const paredIzq = Bodies.rectangle(x - width/2, y, 10, height, opPared);
            
            // üõ°Ô∏è ARQUITECTURA ASIM√âTRICA: La pared derecha es solo el 40% inferior.
            // Esto deja la parte superior completamente libre para que entre la rampa sin chocar.
            const alturaDer = height * 0.4;
            const paredDer = Bodies.rectangle(x + width/2, y + (height - alturaDer)/2, 10, alturaDer, opPared);
            
            // Gu√≠a Izquierda (act√∫a como tablero de b√°squetbol para atrapar las canicas r√°pidas)
            const guiaIzq = Bodies.rectangle(x - width/2 - 10, y - height/2 - 40, 70, 8, { isStatic: true, angle: Math.PI/2.5, render: { fillStyle: '#555' } });
            // Se elimin√≥ por completo la gu√≠a derecha.

            const sensorLaser = Bodies.rectangle(x, y - height/2 + 20, width - 15, 10, { 
                isStatic: true, isSensor: true, label: 'sensor_' + id, render: { fillStyle: 'rgba(255, 0, 0, 0.15)' } 
            });

            // Escotilla est√°tica
            const escotilla = Bodies.rectangle(x, y + height/2, width + 10, 8, { isStatic: true, render: { fillStyle: colorBase } });
            
            const bisagra = Constraint.create({
                pointA: { x: x + width/2 - 5, y: y + height/2 }, bodyB: escotilla, pointB: { x: width/2 - 5, y: 0 }, 
                stiffness: 1, length: 0, render: { visible: false }
            });

            Composite.add(engine.world, [paredIzq, paredDer, guiaIzq, sensorLaser, escotilla, bisagra]);
            modulos[id] = { id, escotilla, limite: limit, conteoActual: 0, abierta: false, origX: x, origY: y + height/2 };
        }

        // üìê TOPOGRAF√çA PERFECTA (Distancias recalibradas para garantizar Clearance)
        crearContenedor('U', 820, 60, 110, 100, 10, '#00E676'); // Base en Y=110
        crearContenedor('D', 500, 440, 130, 150, 100, '#2979FF'); // Base en Y=515
        crearContenedor('C', 180, 840, 160, 150, 9999, '#FFD700'); // Base en Y=915

        // üöÄ RAMPAS CON TOPES (El inicio est√° por debajo de las puertas extendidas)
        // Rampa U -> D. Inicia segura en 890, cae justo en 540 (adentro del contenedor abierto D)
        crearRampa(890, 270, 540, 330); 
        // Rampa D -> C. Inicia segura en 580, cae justo en 220 (adentro del contenedor abierto C)
        crearRampa(580, 690, 220, 750);

        // --- L√ìGICA DE INYECCI√ìN ---
        let canicas = [];

        function inyectarCanica(valor) {
            reproducirSonido(valor === 5 ? 'drop5' : 'drop');
            let color = valor === 5 ? '#FF4081' : '#00E676';
            let radio = valor === 5 ? 9 : 6; // Tombolocha fina, fluye sin atorarse
            let masa = valor === 5 ? 5 : 1; 

            let nuevaCanica = Bodies.circle(820 + (Math.random() * 10 - 5), -20, radio, { 
                restitution: 0.2, mass: masa, friction: 0.001, frictionAir: 0.002, render: { fillStyle: color }
            });
            nuevaCanica.valor = valor; 
            nuevaCanica.sensoresPasados = new Set();
            canicas.push(nuevaCanica);
            Composite.add(engine.world, nuevaCanica);
        }

        function inyectarLote(cantidad) {
            let inyectadas = 0;
            let intervalo = setInterval(() => {
                inyectarCanica(1);
                inyectadas++;
                if (inyectadas >= cantidad) clearInterval(intervalo);
            }, 100); 
        }

        function limpiarMundo() {
            canicas.forEach(c => Composite.remove(engine.world, c));
            canicas = [];
            ['U', 'D', 'C'].forEach(id => { modulos[id].conteoActual = 0; });
            actualizarDisplays();
        }

        function actualizarDisplays() {
            document.getElementById('led-U').innerText = modulos['U'].conteoActual.toString().padStart(2, '0');
            document.getElementById('led-D').innerText = modulos['D'].conteoActual.toString().padStart(3, '0');
            document.getElementById('led-C').innerText = modulos['C'].conteoActual.toString().padStart(3, '0');
        }

        // --- CEREBRO DEL SERVOMOTOR ---
        function accionarServo(id) {
            let mod = modulos[id];
            if (mod.abierta) return;
            mod.abierta = true;
            
            reproducirSonido('victoria'); 
            
            let luzStatus = document.getElementById('servo-' + id);
            if(luzStatus) luzStatus.classList.add('servo-activo');

            Body.setStatic(mod.escotilla, false);

            setTimeout(() => {
                Body.setStatic(mod.escotilla, true);
                Body.setPosition(mod.escotilla, { x: mod.origX, y: mod.origY });
                Body.setVelocity(mod.escotilla, { x: 0, y: 0 });
                Body.setAngle(mod.escotilla, 0);
                Body.setAngularVelocity(mod.escotilla, 0);
                
                if(luzStatus) luzStatus.classList.remove('servo-activo');
                mod.conteoActual = 0; 
                mod.abierta = false;
                actualizarDisplays();
            }, 3000); 
        }

        // --- SENSORES L√ÅSER ---
        Events.on(engine, 'collisionStart', function(event) {
            event.pairs.forEach(pair => {
                let bodyA = pair.bodyA; let bodyB = pair.bodyB;
                let sensor = null; let canica = null;

                if (bodyA.label && bodyA.label.startsWith('sensor_')) { sensor = bodyA; canica = bodyB; }
                else if (bodyB.label && bodyB.label.startsWith('sensor_')) { sensor = bodyB; canica = bodyA; }

                if (sensor && canica && canica.sensoresPasados) {
                    let moduloId = sensor.label.split('_')[1]; 
                    
                    if (!canica.sensoresPasados.has(moduloId)) {
                        canica.sensoresPasados.add(moduloId); 
                        reproducirSonido('beep');
                        
                        let mod = modulos[moduloId];
                        mod.conteoActual += canica.valor;
                        actualizarDisplays();

                        if (moduloId === 'D') canica.render.fillStyle = canica.valor === 5 ? '#B388FF' : '#2979FF'; 
                        if (moduloId === 'C') canica.render.fillStyle = canica.valor === 5 ? '#FF6D00' : '#FFD700'; 

                        if (mod.conteoActual >= mod.limite && !mod.abierta) {
                            accionarServo(moduloId);
                        }
                    }
                }
            });
        });

        Render.run(render);
        const runner = Runner.create(); Runner.run(runner, engine);
    </script>
</body>
</html>
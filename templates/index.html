<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban Cinem√°tico - Robles y Robles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #121212;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        
        #marcador {
            font-size: 3.5em; font-weight: bold; color: #FFD700; 
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace; letter-spacing: 5px;
        }

        .panel-control {
            display: flex; gap: 20px; margin-bottom: 20px; z-index: 20;
            background: #1A1A1A; padding: 15px 25px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .columna-btns { display: flex; flex-direction: column; gap: 8px; align-items: center;}
        .titulo-col { font-size: 0.85em; color: #888; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px;}
        .fila-btns { display: flex; gap: 8px; }
        
        button {
            background-color: #121212; border: 1px solid; padding: 8px 14px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-c { color: #FFD700; border-color: #FFD700; } .btn-c:hover { background-color: #FFD700; color: #121212; }
        .btn-sub { color: #FF5252; border-color: #FF5252; opacity: 0.8;} .btn-sub:hover { background-color: #FF5252; color: #121212; opacity: 1;}
        .btn-reset { color: #BDBDBD; border-color: #BDBDBD; height: 100%; align-self: center; padding: 10px 25px;} .btn-reset:hover { background-color: #BDBDBD; color: #121212; }

        /* üé¨ Escenario de Simulaci√≥n para posicionar los imanes */
        #escenario {
            position: relative;
            width: 800px; height: 450px;
        }

        #canvas-container {
            width: 100%; height: 100%; border: 1px solid #333;
            box-shadow: 0 0 25px rgba(0, 230, 118, 0.15); border-radius: 10px;
            background-color: transparent;
        }

        /* üß≤ Estilo del Electroim√°n Corporativo */
        .iman-visual {
            position: absolute;
            top: -10px;
            width: 80px; height: 35px;
            background: #222;
            border: 2px solid #444;
            border-radius: 8px 8px 20px 20px;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.8);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px;
        }
        
        .iman-visual::after {
            content: ''; width: 60px; height: 10px;
            background: repeating-linear-gradient(90deg, #FF5252, #FF5252 10px, #2979FF 10px, #2979FF 20px);
            border-radius: 5px; opacity: 0.2; transition: opacity 0.3s ease;
        }

        /* Efecto cuando se activa la resta */
        .iman-visual.activo {
            top: 20px; /* Desciende */
            box-shadow: 0 25px 50px rgba(0, 230, 118, 0.6), inset 0 -5px 10px rgba(0,0,0,0.8);
            border-color: #00E676;
        }
        .iman-visual.activo::after { opacity: 1; box-shadow: 0 0 15px #00E676; }

        /* Posiciones exactas sobre cada columna */
        #iman-C { left: 110px; }
        #iman-D { left: 360px; }
        #iman-U { left: 610px; }

    </style>
</head>
<body>
    <h1>SOROBAN CINEM√ÅTICO</h1>
    <div id="marcador">000</div> 
    
    <div class="panel-control">
        <div class="columna-btns">
            <span class="titulo-col">Centenas</span>
            <div class="fila-btns"><button class="btn-c" onclick="operar('C', 1)">+100</button><button class="btn-c" onclick="operar('C', 5)">+500</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('C', -1)">-100</button><button class="btn-sub" onclick="operar('C', -5)">-500</button></div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Decenas</span>
            <div class="fila-btns"><button class="btn-d" onclick="operar('D', 1)">+10</button><button class="btn-d" onclick="operar('D', 5)">+50</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('D', -1)">-10</button><button class="btn-sub" onclick="operar('D', -5)">-50</button></div>
        </div>
        <div class="columna-btns">
            <span class="titulo-col">Unidades</span>
            <div class="fila-btns"><button class="btn-u" onclick="operar('U', 1)">+1</button><button class="btn-u" onclick="operar('U', 5)">+5</button></div>
            <div class="fila-btns"><button class="btn-sub" onclick="operar('U', -1)">-1</button><button class="btn-sub" onclick="operar('U', -5)">-5</button></div>
        </div>
        <button class="btn-reset" onclick="limpiarSoroban()">RESET</button>
    </div>

    <div id="escenario">
        <div id="iman-C" class="iman-visual"></div>
        <div id="iman-D" class="iman-visual"></div>
        <div id="iman-U" class="iman-visual"></div>
        <div id="canvas-container"></div>
    </div>

    <script>
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            let ahora = audioCtx.currentTime;

            if (tipo === 'add') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(600, ahora); osc.frequency.exponentialRampToValueAtTime(1200, ahora + 0.1);
                gainNode.gain.setValueAtTime(0.1, ahora); gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.1);
                osc.start(ahora); osc.stop(ahora + 0.1);
            } else if (tipo === 'sub') {
                // Sonido magn√©tico de succi√≥n
                osc.type = 'square'; osc.frequency.setValueAtTime(200, ahora); osc.frequency.exponentialRampToValueAtTime(800, ahora + 0.3);
                gainNode.gain.setValueAtTime(0.05, ahora); gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.3);
                osc.start(ahora); osc.stop(ahora + 0.3);
            } else if (tipo === 'magia') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, ahora); osc.frequency.setValueAtTime(1200, ahora + 0.1); osc.frequency.setValueAtTime(1600, ahora + 0.2);
                gainNode.gain.setValueAtTime(0.1, ahora); gainNode.gain.linearRampToValueAtTime(0, ahora + 0.3);
                osc.start(ahora); osc.stop(ahora + 0.3);
            }
        }

        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('canvas-container'), engine: engine,
            options: { width: 800, height: 450, wireframes: false, background: 'transparent' }
        });

        const opPared = { render: { fillStyle: '#333' } };

        // üõ†Ô∏è FIX F√çSICO M√ÅXIMO: Paredes extremadamente altas para atrapar cualquier spawn
        function crearColumna(x) {
            const base = Bodies.rectangle(x, 340, 140, 40, opPared); // Suelo m√°s grueso
            // Las paredes ahora cubren desde y=-150 hasta el suelo. Nada se escapa.
            const izq = Bodies.rectangle(x - 60, 100, 20, 500, opPared); 
            const der = Bodies.rectangle(x + 60, 100, 20, 500, opPared);
            const contenedor = Body.create({ parts: [base, izq, der], friction: 0.5, mass: 10, inertia: Infinity });
            const ancla = Bodies.circle(x, -30, 10, { isStatic: true, render: { visible: false } });
            const resorte = Constraint.create({
                bodyA: ancla, bodyB: contenedor, pointB: { x: 0, y: -160 }, 
                stiffness: 0.007, damping: 0.1, length: 180      
            });
            Composite.add(engine.world, [contenedor, ancla, resorte]);
        }

        crearColumna(150); crearColumna(400); crearColumna(650); 

        let valU = 0, valD = 0, valC = 0;
        let canicasCuerpos = []; 

        function actualizarMarcador() {
            let total = (valC * 100) + (valD * 10) + valU;
            document.getElementById('marcador').innerText = total.toString().padStart(3, '0');
        }

        // üß≤ ANIMACI√ìN DEL IM√ÅN DOM
        function animarImanVisual(columna) {
            let ids = columna === 'ALL' ? ['iman-C', 'iman-D', 'iman-U'] : ['iman-' + columna];
            ids.forEach(id => {
                let el = document.getElementById(id);
                if(el) {
                    el.classList.add('activo');
                    setTimeout(() => el.classList.remove('activo'), 500); // Se apaga despu√©s de medio segundo
                }
            });
        }

        function limpiarSoroban() {
            reproducirSonido('sub'); animarImanVisual('ALL');
            aplicarFuerzaMagnetica('ALL');
            setTimeout(() => {
                canicasCuerpos.forEach(c => Composite.remove(engine.world, c));
                canicasCuerpos = []; valU = 0; valD = 0; valC = 0; actualizarMarcador();
            }, 400);
        }

        function crearCanicaFisica(columna, valorMag, offsetY = 0) {
            let x = columna === 'U' ? 650 : (columna === 'D' ? 400 : 150);
            x = x + (Math.random() * 8 - 4); // Offset natural
            
            let radio = valorMag === 1 ? 15 : 30;
            let masa = valorMag === 1 ? 2 : 10;
            let color = '#FFF';

            if (columna === 'U') color = valorMag === 1 ? '#00E676' : '#FF4081'; 
            if (columna === 'D') color = valorMag === 1 ? '#2979FF' : '#B388FF'; 
            if (columna === 'C') color = valorMag === 1 ? '#FFD700' : '#FF6D00'; 

            // Aparecen dentro de los l√≠mites seguros de las nuevas paredes altas
            let nuevaCanica = Bodies.circle(x, -30 - offsetY, radio, { 
                restitution: 0.3, mass: masa, frictionAir: 0.015, render: { fillStyle: color } 
            });
            canicasCuerpos.push(nuevaCanica); Composite.add(engine.world, nuevaCanica);
        }

        // üß≤ F√çSICA DE SUCCI√ìN
        function aplicarFuerzaMagnetica(columnaAfectada) {
            let xCentro = columnaAfectada === 'U' ? 650 : (columnaAfectada === 'D' ? 400 : (columnaAfectada === 'C' ? 150 : -1));
            canicasCuerpos.forEach(c => {
                if (columnaAfectada === 'ALL' || Math.abs(c.position.x - xCentro) < 70) {
                    // Succi√≥n fuerte hacia arriba y hacia el centro del im√°n
                    let dx = (xCentro - c.position.x) * 0.0005; 
                    Matter.Body.applyForce(c, c.position, { x: dx, y: -0.07 * c.mass });
                }
            });
        }

        function operar(columna, valor) {
            if (valor < 0) {
                // Validaci√≥n para evitar restar por debajo de cero cu√°ntico
                let totalActual = (valC * 100) + (valD * 10) + valU;
                let valorAbsoluto = Math.abs(valor) * (columna === 'U' ? 1 : (columna === 'D' ? 10 : 100));
                if (totalActual - valorAbsoluto < 0) return; // Rechazamos la operaci√≥n si nos lleva a negativos
            }

            reproducirSonido(valor > 0 ? 'add' : 'sub');

            if (columna === 'U') valU += valor; if (columna === 'D') valD += valor; if (columna === 'C') valC += valor;

            if (valor > 0) {
                crearCanicaFisica(columna, Math.abs(valor)); actualizarMarcador();
                setTimeout(() => sincronizarEstadoFisico(false), 500); 
            } else {
                // üß≤ EFECTO IM√ÅN VISUAL Y F√çSICO COMBINADO
                animarImanVisual(columna);
                aplicarFuerzaMagnetica(columna);
                setTimeout(() => sincronizarEstadoFisico(true), 400); 
            }
        }

        function sincronizarEstadoFisico(forzarReconstruccion) {
            let total = (valC * 100) + (valD * 10) + valU;
            if (total > 999) total = 999; if (total < 0) total = 0;

            let nC = Math.floor(total / 100); let nD = Math.floor((total % 100) / 10); let nU = total % 10;

            if (nC !== valC || nD !== valD || nU !== valU || forzarReconstruccion) {
                if(nC > valC || nD > valD) reproducirSonido('magia');
                valC = nC; valD = nD; valU = nU;

                canicasCuerpos.forEach(c => Composite.remove(engine.world, c)); canicasCuerpos = [];

                // üõ†Ô∏è FIX F√çSICO: Espaciado de spawn garantizado. La tombolocha necesita 60px de espacio.
                let dropOffset = 0;
                let c5 = Math.floor(valC / 5); let c1 = valC % 5;
                for(let i=0; i<c5; i++) { crearCanicaFisica('C', 5, dropOffset); dropOffset += 65; } // M√°s espacio
                for(let i=0; i<c1; i++) { crearCanicaFisica('C', 1, dropOffset); dropOffset += 35; } 

                dropOffset = 0;
                let d5 = Math.floor(valD / 5); let d1 = valD % 5;
                for(let i=0; i<d5; i++) { crearCanicaFisica('D', 5, dropOffset); dropOffset += 65; }
                for(let i=0; i<d1; i++) { crearCanicaFisica('D', 1, dropOffset); dropOffset += 35; }

                dropOffset = 0;
                let u5 = Math.floor(valU / 5); let u1 = valU % 5;
                for(let i=0; i<u5; i++) { crearCanicaFisica('U', 5, dropOffset); dropOffset += 65; }
                for(let i=0; i<u1; i++) { crearCanicaFisica('U', 1, dropOffset); dropOffset += 35; }
            }
            actualizarMarcador();
        }

        Render.run(render);
        const runner = Runner.create(); Runner.run(runner, engine);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban Cinem√°tico - Robles y Robles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #121212;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #00E676; margin-bottom: 5px; }
        
        /* üéõÔ∏è Estilo del Marcador Digital Hologr√°fico */
        #marcador {
            font-size: 2.5em;
            font-weight: bold;
            color: #FFD700; /* Oro corporativo */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            font-family: 'Courier New', Courier, monospace;
        }

        #canvas-container {
            width: 800px; height: 500px; border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.1); border-radius: 10px; margin-top: 10px;
        }
        .controls { margin-top: 10px; display: flex; gap: 10px; }
        button {
            background-color: #1E1E1E; color: #00E676; border: 1px solid #00E676;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;
        }
        button:hover { background-color: #00E676; color: #121212; }
        .btn-reset { color: #FF5252; border-color: #FF5252; }
        .btn-reset:hover { background-color: #FF5252; color: #121212; }
    </style>
</head>
<body>
    <h1>SOROBAN CINEM√ÅTICO</h1>
    <div id="marcador">000</div> 
    
    <div class="controls">
        <button onclick="agregarCanica(1)">+1 Unidad</button>
        <button onclick="agregarCanica(5)">+5 Unidades</button>
        <button class="btn-reset" onclick="limpiarSoroban()">Limpiar Soroban</button>
    </div>
    <div id="canvas-container"></div>

    <script>
        // Motores y L√≥gica Cu√°ntica por Robles y Robles üè¢‚ú®
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, 
              Composite = Matter.Composite;

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('canvas-container'),
            engine: engine,
            options: { width: 800, height: 500, wireframes: false, background: 'transparent' }
        });

        const opPared = { render: { fillStyle: '#333' } };

        // Funci√≥n para construir columnas con gravedad (C√≥digo modular elegante üìê)
        function crearColumna(x) {
            const base = Bodies.rectangle(x, 350, 140, 20, opPared);
            const izq = Bodies.rectangle(x - 60, 260, 20, 200, opPared);
            const der = Bodies.rectangle(x + 60, 260, 20, 200, opPared);
            const contenedor = Body.create({ parts: [base, izq, der], friction: 0.5, mass: 10, inertia: Infinity });
            const ancla = Bodies.circle(x, 30, 10, { isStatic: true, render: { visible: false } });
            const resorte = Constraint.create({
                bodyA: ancla, bodyB: contenedor, pointB: { x: 0, y: -80 }, 
                stiffness: 0.007, damping: 0.1, length: 150      
            });
            Composite.add(engine.world, [contenedor, ancla, resorte]);
            return contenedor; // Retornamos referencia si la necesitamos luego
        }

        // Instanciamos la arquitectura: Centenas(Izq), Decenas(Centro), Unidades(Der)
        crearColumna(150); // Centenas
        crearColumna(400); // Decenas
        crearColumna(650); // Unidades

        // Variables Globales del Valor
        let valUnidades = 0;
        let valDecenas = 0;
        let valCentenas = 0;
        let canicasCuerpos = []; // Para poder borrarlas todas luego

        // Actualizar el HUD en tiempo real
        function actualizarMarcador() {
            let total = valCentenas * 100 + valDecenas * 10 + valUnidades;
            // Formatear a 3 d√≠gitos (ej. 005, 042, 145)
            document.getElementById('marcador').innerText = total.toString().padStart(3, '0');
        }

        function crearCanicaFisica(columna, valorVisual, tipo) {
            let x = columna === 'unidades' ? 650 : (columna === 'decenas' ? 400 : 150);
            
            // Tama√±os y colores corporativos
            let radio = 15; let color = '#00E676'; let masa = 2; // Unidad base (1, 10, 100)
            
            if (tipo === 'tombolocha') { // La de valor 5
                radio = 30; color = '#FF4081'; masa = 10;
            } else if (columna === 'decenas') {
                radio = 25; color = '#2979FF'; masa = 5; // Decena base
            } else if (columna === 'centenas') {
                radio = 35; color = '#FFD700'; masa = 8; // Centena base (Oro)
            }

            let nuevaCanica = Bodies.circle(x, 60, radio, { restitution: 0.5, mass: masa, render: { fillStyle: color } });
            canicasCuerpos.push(nuevaCanica);
            Composite.add(engine.world, nuevaCanica);
        }

        function limpiarSoroban() {
            // Eliminar todas las canicas f√≠sicas
            canicasCuerpos.forEach(c => Composite.remove(engine.world, c));
            canicasCuerpos = [];
            // Resetear valores l√≥gicos
            valUnidades = 0; valDecenas = 0; valCentenas = 0;
            actualizarMarcador();
        }

        function agregarCanica(valor) {
            valUnidades += valor;
            
            // Instanciar f√≠sicamente
            crearCanicaFisica('unidades', valor, valor === 5 ? 'tombolocha' : 'normal');

            // L√≥gica en Cascada üåä (Unidades -> Decenas -> Centenas)
            if (valUnidades >= 10) {
                setTimeout(() => {
                    let excedenteU = valUnidades - 10;
                    valUnidades = excedenteU;
                    valDecenas += 1; // Subimos una decena
                    
                    // Limpiar gr√°ficamente SOLO unidades (Por ahora limpiamos todo el canvas por simplicidad f√≠sica)
                    // Para un efecto preciso, en el futuro filtraremos por coordenadas X
                    limpiarSoroban(); 
                    
                    // Reconstruir estado actual en cadena
                    valUnidades = excedenteU; 
                    valDecenas += 1;

                    // Desborde a Centenas
                    if(valDecenas >= 10) {
                        let excedenteD = valDecenas - 10;
                        valDecenas = excedenteD;
                        valCentenas += 1;
                    }

                    // Renderizar el nuevo estado
                    for(let i=0; i<valCentenas; i++) crearCanicaFisica('centenas', 100, 'normal');
                    for(let i=0; i<valDecenas; i++) crearCanicaFisica('decenas', 10, 'normal');
                    
                    // Logica de re-renderizado de unidades (Optimizando tomo y uno)
                    let reconstruir5 = Math.floor(valUnidades / 5);
                    let reconstruir1 = valUnidades % 5;
                    for(let i=0; i<reconstruir5; i++) crearCanicaFisica('unidades', 5, 'tombolocha');
                    for(let i=0; i<reconstruir1; i++) crearCanicaFisica('unidades', 1, 'normal');

                    actualizarMarcador();
                }, 500); // üïí Suspenso de medio segundo
            }
            actualizarMarcador();
        }

        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Soroban Cinemático - Prueba Física</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; padding: 0; background-color: #121212;
            color: #E0E0E0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }
        h1 { margin-top: 15px; font-weight: 300; letter-spacing: 2px; color: #FF4081; margin-bottom: 5px; }
        p.sub { color: #888; margin-top: 0; font-size: 0.9em; letter-spacing: 1px;}
        
        .panel-control {
            display: flex; gap: 15px; margin-bottom: 15px; z-index: 20;
            background: #1A1A1A; padding: 12px 20px; border-radius: 12px;
            border: 1px solid #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        button {
            background-color: #121212; border: 1px solid; padding: 8px 15px;
            border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: bold; font-size: 1em;
        }
        .btn-u { color: #00E676; border-color: #00E676; } .btn-u:hover { background-color: #00E676; color: #121212; }
        .btn-d { color: #2979FF; border-color: #2979FF; } .btn-d:hover { background-color: #2979FF; color: #121212; }
        .btn-reset { color: #FF5252; border-color: #FF5252; } .btn-reset:hover { background-color: #FF5252; color: #121212; }

        #canvas-container {
            width: 900px; height: 700px; border: 1px solid #333;
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.15); border-radius: 10px; background-color: transparent;
        }
    </style>
</head>
<body>
    <h1>MODO EXPERIMENTAL: RUBE GOLDBERG</h1>
    <p class="sub">Computación Física Pura por Robles y Robles</p>
    
    <div class="panel-control">
        <button class="btn-u" onclick="inyectarCanicas(1)">Inyectar +1 Micro-Canica</button>
        <button class="btn-d" onclick="inyectarCanicas(10)">Inyectar +10 (Torrente)</button>
        <button class="btn-reset" onclick="limpiarMundo()">Purgar Sistema</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        // --- AUDIO ---
        let audioCtx;
        function reproducirSonido(tipo) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            let ahora = audioCtx.currentTime;
            
            if (tipo === 'drop') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, ahora); osc.frequency.exponentialRampToValueAtTime(1200, ahora + 0.05);
                gainNode.gain.setValueAtTime(0.05, ahora); gainNode.gain.exponentialRampToValueAtTime(0.01, ahora + 0.05);
                osc.start(ahora); osc.stop(ahora + 0.05);
            } else if (tipo === 'alarma') {
                // Sonido de compuerta abriéndose
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, ahora); osc.frequency.linearRampToValueAtTime(150, ahora + 0.4);
                gainNode.gain.setValueAtTime(0.1, ahora); gainNode.gain.linearRampToValueAtTime(0, ahora + 0.4);
                osc.start(ahora); osc.stop(ahora + 0.4);
            }
        }

        // --- MOTOR FÍSICO ---
        const Engine = Matter.Engine, Render = Matter.Render, Runner = Matter.Runner, 
              Bodies = Matter.Bodies, Body = Matter.Body, Constraint = Matter.Constraint, 
              Composite = Matter.Composite, Events = Matter.Events;

        const engine = Engine.create();
        engine.positionIterations = 8; engine.velocityIterations = 8; // Máxima precisión

        const render = Render.create({
            element: document.getElementById('canvas-container'), engine: engine,
            options: { width: 900, height: 700, wireframes: false, background: 'transparent' }
        });

        // --- ARQUITECTURA EN ESCALERA ---
        const opPared = { render: { fillStyle: '#444' } };
        let columnasData = {}; // Guardaremos referencias para abrir las compuertas

        // Función constructora del Contenedor Mecánico
        function crearColumna(id, x, y, stiffness, colorBase) {
            // 1. Base inclinada hacia la IZQUIERDA para que las canicas rueden a la compuerta
            const base = Bodies.rectangle(x, y, 100, 15, { angle: -0.15, render: { fillStyle: '#333' } });
            const paredDer = Bodies.rectangle(x + 45, y - 60, 15, 140, opPared);
            const paredIzqSup = Bodies.rectangle(x - 45, y - 90, 15, 80, opPared); // Deja un hueco abajo

            const contenedor = Body.create({ parts: [base, paredDer, paredIzqSup], friction: 0.1, mass: 15, inertia: Infinity });
            contenedor.label = 'contenedor_' + id;

            // 2. Resorte calibrado
            const ancla = Bodies.circle(x, y - 180, 10, { isStatic: true, render: { visible: false } });
            const resorte = Constraint.create({ bodyA: ancla, bodyB: contenedor, pointB: { x: 0, y: -60 }, stiffness: stiffness, damping: 0.1, length: 120 });

            // 3. La Compuerta (Cuerpo independiente atado con bisagras)
            const puerta = Bodies.rectangle(x - 45, y - 25, 15, 50, { render: { fillStyle: colorBase } });
            
            // Bisagra superior (eje de rotación)
            const bisagra = Constraint.create({ bodyA: contenedor, pointA: { x: -45, y: -50 }, bodyB: puerta, pointB: { x: 0, y: -25 }, stiffness: 1, length: 0, render: { visible: false } });
            // Cerrojo inferior (mantiene cerrada la puerta)
            const cerrojo = Constraint.create({ bodyA: contenedor, pointA: { x: -45, y: 0 }, bodyB: puerta, pointB: { x: 0, y: 25 }, stiffness: 1, length: 0, render: { visible: false } });

            // 4. El Botón Sensor de Presión (Debajo del contenedor)
            const boton = Bodies.rectangle(x, y + 60, 60, 15, { isStatic: true, isSensor: true, render: { fillStyle: '#222' } });
            boton.label = 'boton_' + id;

            Composite.add(engine.world, [contenedor, ancla, resorte, puerta, bisagra, cerrojo, boton]);

            // Guardar en el diccionario para controlarlo después
            columnasData[id] = { id, contenedor, puerta, cerrojo, boton, color: colorBase, abierta: false };
        }

        // --- INSTANCIAR ESCENARIO ---
        // Unidades (Arriba Derecha) - Resorte muy suave (se acciona con 10 canicas)
        crearColumna('U', 750, 200, 0.005, '#00E676');
        
        // Decenas (Medio Centro) - Resorte más tenso (se acciona con 100 canicas)
        crearColumna('D', 450, 400, 0.05, '#2979FF');
        
        // Centenas (Abajo Izquierda) - Contenedor final estático (o muy duro)
        crearColumna('C', 150, 600, 0.5, '#FFD700');

        // --- RAMPAS DE CASCADA ---
        // Rampa de Unidades -> Decenas
        Composite.add(engine.world, Bodies.rectangle(600, 260, 300, 15, { isStatic: true, angle: 0.35, render: { fillStyle: '#555' } }));
        // Rampa de Decenas -> Centenas
        Composite.add(engine.world, Bodies.rectangle(300, 460, 300, 15, { isStatic: true, angle: 0.35, render: { fillStyle: '#555' } }));

        let canicas = [];

        function inyectarCanicas(cantidad) {
            let inyectadas = 0;
            // Torrente en cascada: instanciamos una cada 80ms para no saturar el colisionador
            let intervalo = setInterval(() => {
                reproducirSonido('drop');
                // Aparecen justo sobre el contenedor de Unidades con un micro offset aleatorio
                let nuevaCanica = Bodies.circle(750 + (Math.random() * 20 - 10), 0, 5, { // RADIO = 5 (10 veces más pequeñas!)
                    restitution: 0.4, mass: 1, friction: 0.005, render: { fillStyle: '#00E676' }
                });
                canicas.push(nuevaCanica);
                Composite.add(engine.world, nuevaCanica);
                inyectadas++;
                if (inyectadas >= cantidad) clearInterval(intervalo);
            }, 80);
        }

        function limpiarMundo() {
            canicas.forEach(c => Composite.remove(engine.world, c));
            canicas = [];
        }

        // --- LÓGICA MECÁNICA DE COMPUERTAS ---
        function abrirCompuerta(col) {
            if (col.abierta) return;
            col.abierta = true;
            reproducirSonido('alarma');

            // 1. Iluminar botón como si se encendiera
            col.boton.render.fillStyle = col.color;
            col.boton.render.strokeStyle = '#FFF';
            col.boton.render.lineWidth = 3;

            // 2. Destruir el cerrojo (la compuerta cede a la presión y las canicas caen)
            Composite.remove(engine.world, col.cerrojo);

            // 3. Temporizador neumático para volver a cerrar la compuerta
            setTimeout(() => {
                // Regresar la puerta a su posición y ángulo cerrados usando cinemática
                Body.setAngle(col.puerta, col.contenedor.angle);
                Body.setPosition(col.puerta, { x: col.contenedor.position.x - 45, y: col.contenedor.position.y - 25 });
                
                // Re-soldar el cerrojo
                Composite.add(engine.world, col.cerrojo);
                
                // Apagar el botón
                col.boton.render.fillStyle = '#222';
                col.boton.render.lineWidth = 0;
                col.abierta = false;
            }, 3500); // 3.5 segundos para asegurar que todas salgan
        }

        // --- SENSORES DE COLISIÓN (EL CEREBRO DEL RUBE GOLDBERG) ---
        Events.on(engine, 'collisionStart', function(event) {
            event.pairs.forEach(pair => {
                let a = pair.bodyA.label;
                let b = pair.bodyB.label;

                // Detectar si el Contenedor de Unidades toca su Botón
                if ((a === 'contenedor_U' && b === 'boton_U') || (b === 'contenedor_U' && a === 'boton_U')) {
                    abrirCompuerta(columnasData['U']);
                }
                // Detectar si el Contenedor de Decenas toca su Botón
                if ((a === 'contenedor_D' && b === 'boton_D') || (b === 'contenedor_D' && a === 'boton_D')) {
                    abrirCompuerta(columnasData['D']);
                }
            });
        });

        Render.run(render);
        const runner = Runner.create(); Runner.run(runner, engine);
    </script>
</body>
</html>